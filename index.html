<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>L'Arca di No√® üåà - I Due Liocorni</title>
<style>
/* === CSS VARIABLES === */
:root {
  --bg-hue: 200;
  --bg-sat: 80%;
  --bg-light: 90%;
}

/* === RESET === */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', 'SF Pro', 'Helvetica Neue', Arial, sans-serif;
  background: hsl(var(--bg-hue), var(--bg-sat), var(--bg-light));
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.8s ease;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
  cursor: default;
}

/* === CANVASES === */
canvas {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 0;
}
#rain-canvas { z-index: 2; display: none; }
#particle-canvas { z-index: 100; }

/* === TITLE BANNER === */
.title-banner {
  position: relative;
  z-index: 10;
  text-align: center;
  padding: 20px 16px 10px;
}

.ark-container {
  font-size: clamp(50px, 12vw, 90px);
  animation: rockArk 3s ease-in-out infinite;
  display: inline-block;
  filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.15));
}

@keyframes rockArk {
  0%, 100% { transform: rotate(-4deg) translateY(0); }
  50% { transform: rotate(4deg) translateY(-6px); }
}

.title-banner h1 {
  font-size: clamp(28px, 7vw, 56px);
  font-weight: 900;
  background: linear-gradient(90deg, #ff6b6b, #ffa500, #ffd93d, #6bcb77, #4d96ff, #9b59b6, #ff6b9d);
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: rainbowShift 4s linear infinite;
  text-shadow: none;
  line-height: 1.2;
  margin-top: -5px;
}

@keyframes rainbowShift {
  0% { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}

/* === CONTROLS === */
.controls {
  display: flex;
  justify-content: center;
  gap: 14px;
  padding: 10px 16px 16px;
  position: relative;
  z-index: 10;
  flex-wrap: wrap;
}

.ctrl-btn {
  font-size: clamp(16px, 4vw, 22px);
  font-weight: 800;
  border: none;
  border-radius: 50px;
  padding: 12px 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.ctrl-btn:active { transform: scale(0.93); }

.btn-music {
  background: linear-gradient(135deg, #ff6b9d, #c44dff);
}
.btn-music.playing {
  animation: pulseBtnMusic 0.6s ease-in-out infinite alternate;
}
@keyframes pulseBtnMusic {
  from { box-shadow: 0 4px 15px rgba(196, 77, 255, 0.4); }
  to { box-shadow: 0 4px 30px rgba(196, 77, 255, 0.8); transform: scale(1.04); }
}

.btn-rain {
  background: linear-gradient(135deg, #4d96ff, #00d2d3);
}
.btn-rain.active {
  animation: pulseBtnRain 0.8s ease-in-out infinite alternate;
}
@keyframes pulseBtnRain {
  from { box-shadow: 0 4px 15px rgba(77, 150, 255, 0.4); }
  to { box-shadow: 0 4px 30px rgba(77, 150, 255, 0.8); transform: scale(1.04); }
}

.btn-skip {
  background: linear-gradient(135deg, #f7971e, #ffd200);
  padding: 12px 18px;
}

.btn-icon { font-size: 1.3em; }

/* === SONG LABEL === */
.song-label {
  text-align: center;
  position: relative;
  z-index: 10;
  margin: -8px 0 8px;
  font-size: clamp(12px, 2.5vw, 16px);
  font-weight: 700;
  color: rgba(0,0,0,0.45);
  min-height: 1.4em;
  transition: opacity 0.4s;
}
.song-label.hidden { opacity: 0; }

/* === ANIMAL GRID === */
.animal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
  padding: 8px 20px 30px;
  max-width: 900px;
  margin: 0 auto;
  position: relative;
  z-index: 10;
}

@media (max-width: 500px) {
  .animal-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 8px 12px 30px;
  }
}

/* === ANIMAL CARD === */
.animal-card {
  background: rgba(255,255,255,0.85);
  border-radius: 24px;
  padding: 16px 10px 14px;
  text-align: center;
  cursor: pointer;
  transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12), inset 0 2px 0 rgba(255,255,255,0.8);
  position: relative;
  overflow: visible;
  animation: idleWobble 4s ease-in-out infinite;
  border: 3px solid rgba(255,255,255,0.6);
}

.animal-card:nth-child(1) { animation-delay: 0s; }
.animal-card:nth-child(2) { animation-delay: 0.5s; }
.animal-card:nth-child(3) { animation-delay: 1s; }
.animal-card:nth-child(4) { animation-delay: 1.5s; }
.animal-card:nth-child(5) { animation-delay: 2s; }
.animal-card:nth-child(6) { animation-delay: 2.5s; }
.animal-card:nth-child(7)  { animation-delay: 3s; }
.animal-card:nth-child(8)  { animation-delay: 3.5s; }
.animal-card:nth-child(9)  { animation-delay: 4s; }
.animal-card:nth-child(10) { animation-delay: 4.5s; }

@keyframes idleWobble {
  0%, 100% { transform: rotate(0deg) scale(1); }
  25% { transform: rotate(-1.5deg) scale(1.01); }
  75% { transform: rotate(1.5deg) scale(1.01); }
}

.animal-card:active { animation: none; }

.animal-card.bounce {
  animation: bounceCard 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes bounceCard {
  0% { transform: scale(1); }
  20% { transform: scale(0.85); }
  40% { transform: scale(1.2) rotate(-3deg); }
  60% { transform: scale(0.95) rotate(2deg); }
  80% { transform: scale(1.08); }
  100% { transform: scale(1) rotate(0); }
}

.animal-emoji {
  font-size: clamp(60px, 15vw, 100px);
  line-height: 1.1;
  display: block;
  filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.15));
  transition: transform 0.3s;
}

.animal-card.bounce .animal-emoji {
  animation: emojiJump 0.6s ease;
}

@keyframes emojiJump {
  0%, 100% { transform: translateY(0) rotate(0); }
  30% { transform: translateY(-15px) rotate(-10deg); }
  60% { transform: translateY(-5px) rotate(5deg); }
}

.animal-name {
  font-size: clamp(16px, 3.5vw, 24px);
  font-weight: 800;
  margin-top: 6px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  line-height: 1.2;
}

.animal-card:nth-child(1)  .animal-name { color: #c44dff; }
.animal-card:nth-child(2)  .animal-name { color: #e08e00; }
.animal-card:nth-child(3)  .animal-name { color: #c0392b; }
.animal-card:nth-child(4)  .animal-name { color: #27ae60; }
.animal-card:nth-child(5)  .animal-name { color: #16a085; }
.animal-card:nth-child(6)  .animal-name { color: #2980b9; }
.animal-card:nth-child(7)  .animal-name { color: #e67e22; }
.animal-card:nth-child(8)  .animal-name { color: #d4a800; }
.animal-card:nth-child(9)  .animal-name { color: #1abc9c; }
.animal-card:nth-child(10) .animal-name { color: #27ae60; }

.animal-card:hover {
  box-shadow: 0 8px 30px rgba(0,0,0,0.18), inset 0 2px 0 rgba(255,255,255,0.8);
}

/* x2 badge (two by two onto the ark!) */
.pair-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: linear-gradient(135deg, #ffd93d, #ff9a00);
  color: #fff;
  font-size: 14px;
  font-weight: 900;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(255,154,0,0.4);
  text-shadow: 1px 1px 0 rgba(0,0,0,0.15);
  border: 2px solid #fff;
}

/* === FOOTER === */
.footer {
  text-align: center;
  padding: 10px 16px 24px;
  position: relative;
  z-index: 10;
  color: rgba(0,0,0,0.35);
  font-size: 14px;
  font-weight: 600;
}

/* === SCROLLBAR === */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 4px; }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<canvas id="rain-canvas"></canvas>
<canvas id="particle-canvas"></canvas>

<div class="title-banner">
  <div class="ark-container">üö¢</div>
  <h1>L'Arca di No√® üåà</h1>
</div>

<div id="yt-player" style="position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;"></div>

<div class="controls">
  <button class="ctrl-btn btn-music" id="musicBtn" aria-label="Suona la musica">
    <span class="btn-icon">üéµ</span> Musica
  </button>
  <button class="ctrl-btn btn-skip" id="skipBtn" aria-label="Canzone successiva" style="display:none;">
    <span class="btn-icon">‚è≠Ô∏è</span>
  </button>
  <button class="ctrl-btn btn-rain" id="rainBtn" aria-label="Attiva la pioggia">
    <span class="btn-icon">üåßÔ∏è</span> Pioggia
  </button>
</div>
<div class="song-label hidden" id="songLabel">üéµ</div>

<div class="animal-grid" id="animalGrid"></div>

<div class="footer">
  üåä Due per due sull'arca üåä
</div>

<script>
// ============================================================
//  AUDIO CONTEXT (lazy-init on first user gesture)
// ============================================================
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// ============================================================
//  ANIMAL DATA
// ============================================================
const animals = [
  { emoji: 'ü¶Ñ', name: 'Liocorni',    sound: 'unicorn',  bgHue: 290 },
  { emoji: 'üê±', name: 'Gatti',       sound: 'cat',      bgHue: 35  },
  { emoji: 'üêÄ', name: 'Ratti',       sound: 'rat',      bgHue: 0   },
  { emoji: 'üêò', name: 'Elefanti',    sound: 'elephant', bgHue: 130 },
  { emoji: 'üêä', name: 'Coccodrilli', sound: 'croc',     bgHue: 160 },
  { emoji: 'üêß', name: 'Pinguini',    sound: 'penguin',  bgHue: 210 },
  { emoji: 'üêç', name: 'Serpenti',    sound: 'snake',    bgHue: 60  },
  { emoji: 'ü¶Å', name: 'Leoni',       sound: 'lion',     bgHue: 25  },
  { emoji: 'üê¢', name: 'Tartarughe',  sound: 'turtle',   bgHue: 170 },
  { emoji: 'ü¶ú', name: 'Pappagalli',  sound: 'parrot',   bgHue: 45  },
];

// ============================================================
//  BUILD ANIMAL GRID
// ============================================================
const grid = document.getElementById('animalGrid');
animals.forEach((a, i) => {
  const card = document.createElement('div');
  card.className = 'animal-card';
  card.setAttribute('role', 'button');
  card.setAttribute('aria-label', a.name);
  card.innerHTML = `
    <span class="animal-emoji">${a.emoji}</span>
    <div class="animal-name">${a.name}</div>
    <div class="pair-badge">x2</div>
  `;
  card.addEventListener('click', (e) => {
    e.stopPropagation();
    onAnimalTap(card, a, i);
  });
  card.addEventListener('touchstart', () => {}, { passive: true });
  grid.appendChild(card);
});

// ============================================================
//  ANIMAL TAP HANDLER
// ============================================================
function onAnimalTap(card, animal, index) {
  card.classList.remove('bounce');
  void card.offsetWidth;
  card.classList.add('bounce');
  setTimeout(() => card.classList.remove('bounce'), 700);

  playAnimalSound(animal.sound);

  const rect = card.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  burstParticles(cx, cy, 18);

  document.documentElement.style.setProperty('--bg-hue', animal.bgHue);
  document.documentElement.style.setProperty('--bg-sat', '75%');
  document.documentElement.style.setProperty('--bg-light', '88%');
}

// ============================================================
//  SYNTHESIZED ANIMAL SOUNDS
// ============================================================
function playAnimalSound(type) {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;

  switch(type) {
    case 'unicorn': {
      const freqs = [523, 659, 784, 1047, 1319];
      freqs.forEach((f, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(f, now + i * 0.08);
        gain.gain.setValueAtTime(0.25, now + i * 0.08);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.4);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now + i * 0.08);
        osc.stop(now + i * 0.08 + 0.5);
      });
      break;
    }
    case 'cat': {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(300, now);
      osc.frequency.linearRampToValueAtTime(700, now + 0.15);
      osc.frequency.linearRampToValueAtTime(400, now + 0.4);
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
      osc.connect(gain).connect(ctx.destination);
      osc.start(now);
      osc.stop(now + 0.55);
      break;
    }
    case 'rat': {
      for (let i = 0; i < 3; i++) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(2000 + Math.random() * 500, now + i * 0.1);
        osc.frequency.linearRampToValueAtTime(2500 + Math.random() * 300, now + i * 0.1 + 0.05);
        gain.gain.setValueAtTime(0.15, now + i * 0.1);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.12);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now + i * 0.1);
        osc.stop(now + i * 0.1 + 0.15);
      }
      break;
    }
    case 'elephant': {
      const osc = ctx.createOscillator();
      const osc2 = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sawtooth';
      osc2.type = 'square';
      osc.frequency.setValueAtTime(150, now);
      osc.frequency.linearRampToValueAtTime(350, now + 0.2);
      osc.frequency.linearRampToValueAtTime(200, now + 0.6);
      osc2.frequency.setValueAtTime(153, now);
      osc2.frequency.linearRampToValueAtTime(355, now + 0.2);
      osc2.frequency.linearRampToValueAtTime(205, now + 0.6);
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.setValueAtTime(0.25, now + 0.2);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.7);
      osc.connect(gain);
      osc2.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now); osc.stop(now + 0.75);
      osc2.start(now); osc2.stop(now + 0.75);
      break;
    }
    case 'croc': {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(80, now);
      osc.frequency.exponentialRampToValueAtTime(60, now + 0.3);
      gain.gain.setValueAtTime(0.3, now);
      gain.gain.linearRampToValueAtTime(0.15, now + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
      osc.connect(gain).connect(ctx.destination);
      osc.start(now); osc.stop(now + 0.45);
      const snap = ctx.createOscillator();
      const sg = ctx.createGain();
      snap.type = 'square';
      snap.frequency.setValueAtTime(200, now + 0.05);
      snap.frequency.exponentialRampToValueAtTime(40, now + 0.15);
      sg.gain.setValueAtTime(0.25, now + 0.05);
      sg.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
      snap.connect(sg).connect(ctx.destination);
      snap.start(now + 0.05); snap.stop(now + 0.2);
      break;
    }
    case 'penguin': {
      for (let i = 0; i < 2; i++) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(600, now + i * 0.2);
        osc.frequency.linearRampToValueAtTime(450, now + i * 0.2 + 0.1);
        gain.gain.setValueAtTime(0.15, now + i * 0.2);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.2 + 0.18);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now + i * 0.2); osc.stop(now + i * 0.2 + 0.2);
      }
      break;
    }
    case 'snake': {
      const bufferSize = ctx.sampleRate * 0.5;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;
      const filter = ctx.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.setValueAtTime(4000, now);
      filter.frequency.linearRampToValueAtTime(8000, now + 0.3);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
      noise.connect(filter).connect(gain).connect(ctx.destination);
      noise.start(now); noise.stop(now + 0.55);
      break;
    }
    case 'lion': {
      // Deep roar: low sawtooth sweep with harmonics
      const osc1 = ctx.createOscillator();
      const osc2 = ctx.createOscillator();
      const osc3 = ctx.createOscillator();
      const gain = ctx.createGain();
      osc1.type = 'sawtooth'; osc2.type = 'sawtooth'; osc3.type = 'square';
      osc1.frequency.setValueAtTime(100, now); osc1.frequency.linearRampToValueAtTime(55, now + 0.8);
      osc2.frequency.setValueAtTime(105, now); osc2.frequency.linearRampToValueAtTime(58, now + 0.8);
      osc3.frequency.setValueAtTime(50,  now); osc3.frequency.linearRampToValueAtTime(30, now + 0.8);
      gain.gain.setValueAtTime(0.0, now);
      gain.gain.linearRampToValueAtTime(0.28, now + 0.1);
      gain.gain.setValueAtTime(0.28, now + 0.5);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
      osc1.connect(gain); osc2.connect(gain); osc3.connect(gain);
      gain.connect(ctx.destination);
      osc1.start(now); osc1.stop(now + 0.95);
      osc2.start(now); osc2.stop(now + 0.95);
      osc3.start(now); osc3.stop(now + 0.95);
      break;
    }
    case 'turtle': {
      // Slow, deep, gentle hum
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(120, now);
      osc.frequency.linearRampToValueAtTime(110, now + 0.6);
      gain.gain.setValueAtTime(0.0, now);
      gain.gain.linearRampToValueAtTime(0.18, now + 0.2);
      gain.gain.setValueAtTime(0.18, now + 0.5);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
      // add gentle wobble via a second low-volume osc
      const osc2 = ctx.createOscillator();
      const gain2 = ctx.createGain();
      osc2.type = 'sine';
      osc2.frequency.setValueAtTime(240, now);
      gain2.gain.setValueAtTime(0.05, now);
      gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
      osc.connect(gain).connect(ctx.destination);
      osc2.connect(gain2).connect(ctx.destination);
      osc.start(now); osc.stop(now + 0.95);
      osc2.start(now); osc2.stop(now + 0.95);
      break;
    }
    case 'parrot': {
      // Fast chirpy arpeggio
      const notes = [1200, 1600, 1400, 1800, 1500, 2000];
      notes.forEach((f, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(f, now + i * 0.06);
        osc.frequency.linearRampToValueAtTime(f * 1.1, now + i * 0.06 + 0.03);
        gain.gain.setValueAtTime(0.18, now + i * 0.06);
        gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.06 + 0.07);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now + i * 0.06);
        osc.stop(now + i * 0.06 + 0.1);
      });
      break;
    }
  }
}

// ============================================================
//  YOUTUBE JUKEBOX
// ============================================================
const playlist = [
  { title: 'I Due Liocorni',         id: '8M6JrmIQiTc' },
  { title: 'Il Coccodrillo Come Fa', id: 'mKAPO_nYV1o'  },
  { title: 'Nella Vecchia Fattoria', id: '4HywQgnGxRI'  },
  { title: 'Stella Stellina',        id: 'vrcf5kWXKZk'  },
  { title: 'Ci Vuole Un Fiore',      id: 'mrd7CxDxyEE'  },
];

let currentSong = 0;
let ytPlayer = null;
let ytReady = false;
let musicPlaying = false;
let musicTimeout = null;

const musicBtn  = document.getElementById('musicBtn');
const skipBtn   = document.getElementById('skipBtn');
const songLabel = document.getElementById('songLabel');

// Load YouTube IFrame API
(function loadYT() {
  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  tag.onerror = () => { /* fallback below */ };
  document.head.appendChild(tag);
})();

// Called by YouTube IFrame API when ready
window.onYouTubeIframeAPIReady = function() {
  ytReady = true;
  ytPlayer = new YT.Player('yt-player', {
    height: '1', width: '1',
    videoId: playlist[currentSong].id,
    playerVars: { autoplay: 0, controls: 0, rel: 0, showinfo: 0, origin: window.location.origin },
    events: {
      onStateChange: (e) => {
        if (e.data === YT.PlayerState.ENDED) advanceSong();
        if (e.data === YT.PlayerState.PLAYING) {
          musicBtn.classList.add('playing');
          musicBtn.querySelector('.btn-icon').textContent = 'üîä';
          musicPlaying = true;
          skipBtn.style.display = 'flex';
          showSongLabel();
        }
        if (e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.CUED) {
          musicBtn.classList.remove('playing');
          musicBtn.querySelector('.btn-icon').textContent = 'üéµ';
          musicPlaying = false;
        }
      },
      onError: () => advanceSong()
    }
  });
};

function showSongLabel() {
  songLabel.textContent = 'üéµ ' + playlist[currentSong].title;
  songLabel.classList.remove('hidden');
}

function advanceSong() {
  currentSong = (currentSong + 1) % playlist.length;
  if (ytPlayer && ytReady) {
    ytPlayer.loadVideoById(playlist[currentSong].id);
    showSongLabel();
  }
}

musicBtn.addEventListener('click', () => {
  getAudioCtx(); // unlock audio context
  if (!ytReady || !ytPlayer) {
    // fallback: play synthesized melody if YouTube not available
    musicPlaying = !musicPlaying;
    if (musicPlaying) {
      musicBtn.classList.add('playing');
      musicBtn.querySelector('.btn-icon').textContent = 'üîä';
      playFallbackMelody();
    } else {
      musicBtn.classList.remove('playing');
      musicBtn.querySelector('.btn-icon').textContent = 'üéµ';
      clearTimeout(musicTimeout);
    }
    return;
  }
  const state = ytPlayer.getPlayerState();
  if (state === YT.PlayerState.PLAYING) {
    ytPlayer.pauseVideo();
    musicPlaying = false;
    musicBtn.classList.remove('playing');
    musicBtn.querySelector('.btn-icon').textContent = 'üéµ';
  } else {
    ytPlayer.loadVideoById(playlist[currentSong].id);
    showSongLabel();
    musicPlaying = true;
  }
});

skipBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  advanceSong();
});

// Simple synthesized melody fallback (no YouTube)
const melodyNotes = [
  {f:262,d:0.25},{f:330,d:0.25},{f:392,d:0.25},{f:523,d:0.5},
  {f:494,d:0.25},{f:440,d:0.25},{f:392,d:0.5},{f:0,d:0.25},
  {f:349,d:0.25},{f:440,d:0.25},{f:392,d:0.25},{f:349,d:0.25},
  {f:330,d:0.5}, {f:294,d:0.25},{f:262,d:0.5}, {f:0,d:0.5},
];
function playFallbackMelody() {
  if (!musicPlaying) return;
  const ctx = getAudioCtx(); const now = ctx.currentTime;
  let t = 0;
  melodyNotes.forEach(n => {
    if (n.f > 0) {
      const osc = ctx.createOscillator(); const g = ctx.createGain();
      osc.type = 'triangle'; osc.frequency.setValueAtTime(n.f, now + t);
      g.gain.setValueAtTime(0.15, now + t);
      g.gain.exponentialRampToValueAtTime(0.001, now + t + n.d);
      osc.connect(g).connect(ctx.destination);
      osc.start(now + t); osc.stop(now + t + n.d + 0.05);
    }
    t += n.d;
  });
  const total = melodyNotes.reduce((s, n) => s + n.d, 0) * 1000;
  musicTimeout = setTimeout(() => { if (musicPlaying) playFallbackMelody(); }, total + 100);
}

// ============================================================
//  RAIN TOGGLE
// ============================================================
let rainActive = false;
const rainBtn = document.getElementById('rainBtn');
const rainCanvas = document.getElementById('rain-canvas');

rainBtn.addEventListener('click', () => {
  rainActive = !rainActive;
  rainCanvas.style.display = rainActive ? 'block' : 'none';
  rainBtn.classList.toggle('active', rainActive);
  if (rainActive) playRainSound();
});

function playRainSound() {
  if (!rainActive) return;
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  const bufferSize = ctx.sampleRate * 2;
  const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
  const noise = ctx.createBufferSource();
  noise.buffer = buffer;
  const filter = ctx.createBiquadFilter();
  filter.type = 'bandpass';
  filter.frequency.value = 3000;
  filter.Q.value = 0.5;
  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.06, now);
  gain.gain.setValueAtTime(0.06, now + 1.8);
  gain.gain.linearRampToValueAtTime(0, now + 2);
  noise.connect(filter).connect(gain).connect(ctx.destination);
  noise.start(now); noise.stop(now + 2);
  setTimeout(() => { if (rainActive) playRainSound(); }, 1900);
}

// ============================================================
//  RAIN ANIMATION
// ============================================================
const rainCtx2d = rainCanvas.getContext('2d');
const raindrops = [];

function resizeRainCanvas() {
  rainCanvas.width = window.innerWidth;
  rainCanvas.height = window.innerHeight;
}
resizeRainCanvas();

function animateRain() {
  if (!rainActive) {
    rainCtx2d.clearRect(0, 0, rainCanvas.width, rainCanvas.height);
    requestAnimationFrame(animateRain);
    return;
  }
  rainCtx2d.clearRect(0, 0, rainCanvas.width, rainCanvas.height);

  for (let i = 0; i < 4; i++) {
    raindrops.push({
      x: Math.random() * rainCanvas.width,
      y: -10,
      speed: 6 + Math.random() * 8,
      length: 15 + Math.random() * 20,
      opacity: 0.3 + Math.random() * 0.4
    });
  }

  for (let i = raindrops.length - 1; i >= 0; i--) {
    const d = raindrops[i];
    d.y += d.speed;
    if (d.y > rainCanvas.height + 20) {
      raindrops.splice(i, 1);
      continue;
    }
    rainCtx2d.beginPath();
    rainCtx2d.moveTo(d.x, d.y);
    rainCtx2d.lineTo(d.x + 1, d.y + d.length);
    rainCtx2d.strokeStyle = `rgba(100, 160, 255, ${d.opacity})`;
    rainCtx2d.lineWidth = 2;
    rainCtx2d.lineCap = 'round';
    rainCtx2d.stroke();
  }

  if (raindrops.length > 500) raindrops.splice(0, raindrops.length - 500);
  requestAnimationFrame(animateRain);
}
animateRain();

// ============================================================
//  PARTICLE / CONFETTI SYSTEM
// ============================================================
const particleCanvas = document.getElementById('particle-canvas');
const pCtx = particleCanvas.getContext('2d');
const particles = [];

function resizeParticleCanvas() {
  particleCanvas.width = window.innerWidth;
  particleCanvas.height = window.innerHeight;
}
resizeParticleCanvas();

const confettiColors = [
  '#ff6b6b', '#ffa500', '#ffd93d', '#6bcb77', '#4d96ff',
  '#9b59b6', '#ff6b9d', '#00d2d3', '#ff9ff3', '#f368e0'
];

function burstParticles(x, y, count) {
  for (let i = 0; i < count; i++) {
    const angle = (Math.PI * 2 * i) / count + Math.random() * 0.5;
    const speed = 3 + Math.random() * 6;
    const size = 5 + Math.random() * 8;
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 2,
      size,
      color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
      life: 1,
      decay: 0.015 + Math.random() * 0.015,
      rotation: Math.random() * Math.PI * 2,
      rotSpeed: (Math.random() - 0.5) * 0.3,
      shape: Math.random() > 0.5 ? 'circle' : 'rect'
    });
  }
}

function spawnSparkles(x, y, count) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 1 + Math.random() * 3;
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      size: 2 + Math.random() * 4,
      color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
      life: 1,
      decay: 0.03 + Math.random() * 0.02,
      rotation: 0,
      rotSpeed: 0,
      shape: 'circle'
    });
  }
}

function animateParticles() {
  pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.15;
    p.vx *= 0.99;
    p.life -= p.decay;
    p.rotation += p.rotSpeed;

    if (p.life <= 0) {
      particles.splice(i, 1);
      continue;
    }

    pCtx.save();
    pCtx.globalAlpha = p.life;
    pCtx.translate(p.x, p.y);
    pCtx.rotate(p.rotation);
    pCtx.fillStyle = p.color;

    if (p.shape === 'circle') {
      pCtx.beginPath();
      pCtx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
      pCtx.fill();
    } else {
      pCtx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2);
    }
    pCtx.restore();
  }

  if (particles.length > 600) particles.splice(0, particles.length - 600);
  requestAnimationFrame(animateParticles);
}
animateParticles();

// Background tap sparkles + sound
document.body.addEventListener('click', (e) => {
  spawnSparkles(e.clientX, e.clientY, 8);
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(800 + Math.random() * 600, now);
  gain.gain.setValueAtTime(0.06, now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
  osc.connect(gain).connect(ctx.destination);
  osc.start(now); osc.stop(now + 0.12);
});

// ============================================================
//  BACKGROUND FLOATING ELEMENTS
// ============================================================
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d');

function resizeBgCanvas() {
  bgCanvas.width = window.innerWidth;
  bgCanvas.height = window.innerHeight;
}
resizeBgCanvas();

const floaters = [];
const floaterEmojis = ['‚òÅÔ∏è', '‚≠ê', '‚ú®', 'üåü', '‚òÅÔ∏è', '‚òÅÔ∏è', 'üí´', 'ü¶ã'];

for (let i = 0; i < 15; i++) {
  floaters.push({
    x: Math.random() * window.innerWidth,
    y: Math.random() * window.innerHeight,
    emoji: floaterEmojis[Math.floor(Math.random() * floaterEmojis.length)],
    size: 20 + Math.random() * 30,
    speedX: 0.2 + Math.random() * 0.5,
    wobblePhase: Math.random() * Math.PI * 2,
    wobbleSpeed: 0.01 + Math.random() * 0.02,
    opacity: 0.2 + Math.random() * 0.3
  });
}

function animateBackground() {
  bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);

  floaters.forEach(f => {
    f.x += f.speedX;
    f.wobblePhase += f.wobbleSpeed;
    const wobbleY = Math.sin(f.wobblePhase) * 15;
    if (f.x > bgCanvas.width + 60) f.x = -60;

    bgCtx.save();
    bgCtx.globalAlpha = f.opacity;
    bgCtx.font = `${f.size}px serif`;
    bgCtx.fillText(f.emoji, f.x, f.y + wobbleY);
    bgCtx.restore();
  });

  requestAnimationFrame(animateBackground);
}
animateBackground();

// ============================================================
//  RESIZE HANDLER
// ============================================================
window.addEventListener('resize', () => {
  resizeBgCanvas();
  resizeParticleCanvas();
  resizeRainCanvas();
});

// ============================================================
//  KEYBOARD SUPPORT (for Stream Deck hotkeys)
//  Keys 1-9: animals 1-9, 0: animal 10
//  M: music toggle, N: next song, R: rain toggle
// ============================================================
document.addEventListener('keydown', (e) => {
  const key = e.key;

  // 1-9 = animals 1-9, 0 = animal 10
  const animalCards = document.querySelectorAll('.animal-card');
  if (/^[0-9]$/.test(key)) {
    const idx = key === '0' ? 9 : parseInt(key) - 1;
    if (idx < animals.length) {
      const card = animalCards[idx];
      onAnimalTap(card, animals[idx], idx);
    }
    return;
  }

  // M toggles music
  if (key === 'm' || key === 'M') { musicBtn.click(); return; }

  // N / ‚Üí skips to next song
  if (key === 'n' || key === 'N') { advanceSong(); return; }

  // R toggles rain
  if (key === 'r' || key === 'R') { rainBtn.click(); return; }
});

// Prevent zoom on iOS
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
</script>
</body>
</html>
